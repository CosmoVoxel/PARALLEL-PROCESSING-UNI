name: Update Performance Metrics

# Triggers for the workflow
on:
  # Run when manually triggered using GitHub's UI
  workflow_dispatch:
  
  # Run on pushes to main branch that modify C files or scripts
  push:
    branches: [ main ]
    paths:
      - '**.c'
      - '**.h'
      - 'test_*.sh'
      - 'find_optimal_blocksize.sh'
  
  # Run on pull requests to main branch that modify C files or scripts
  pull_request:
    branches: [ main ]
    paths:
      - '**.c'
      - '**.h'
      - 'test_*.sh'
      - 'find_optimal_blocksize.sh'
  
  # Run once a week (Sunday at 00:00 UTC)
  schedule:
    - cron: '0 0 * * 0'

# Set permissions for the workflow
permissions:
  contents: write

jobs:
  update-metrics:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        # Ensure we fetch complete history for proper commits
        fetch-depth: 0
            
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential bc
    
    - name: Ensure scripts are executable
      run: |
        chmod +x find_optimal_blocksize.sh
        chmod +x test_ranges.sh
    
    - name: Create build directory
      run: mkdir -p build
    
    - name: Find optimal block size
      run: ./find_optimal_blocksize.sh
    
    - name: Run performance tests
      run: ./test_ranges.sh
      
    - name: Add system information to README
      run: |
        # Get the current system information
        SYSTEM_INFO=$(cat << 'EOF'
        - Date: $(date)
        - CPU Model: $(grep 'model name' /proc/cpuinfo | head -n1 | cut -d':' -f2 | xargs)
        - CPU Cores: $(grep -c processor /proc/cpuinfo)
        - Memory: $(free -h | awk '/^Mem:/ {print $2}')
        - OS: $(lsb_release -ds)
        - Kernel: $(uname -r)
        - Optimal block size: $(cat optimal_block_size.txt) bytes
        EOF
        )
        
        # Insert system information after the System Specification section
        sed -i "/^## Cache-Optimized Block Size/i $SYSTEM_INFO" README.md
    
    - name: Commit files
      run: |
        git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add README.md range_results.txt block_size_results.txt optimal_block_size.txt
        git commit -m "Update performance metrics [skip ci]"
    
    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref }}